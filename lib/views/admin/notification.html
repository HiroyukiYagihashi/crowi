{% extends '../layout/admin.html' %}

{% block html_title %}通知設定 · {{ path }}{% endblock %}

{% block content_head %}
<div class="header-wrap">
  <header id="page-header">
    <h1 class="title" id="">通知設定</h1>
  </header>
</div>
{% endblock %}

{% block content_main %}
<div class="content-main content-form">
  <div class="row">
    <div class="col-md-3">
      {% include './widget/menu.html' with {current: 'notification'} %}
    </div>
    <div class="col-md-9">

      <ul class="nav nav-tabs">
        <li class="nav-item"><a class="nav-link active" href="#slack" data-toggle="tab"><i class="fab fa-slack"></i> Slack</a></li>
      </ul>

      <br>

      {% set smessage = req.flash('successMessage') %}
      {% if smessage.length %}
      <div class="alert alert-success">
        {% for e in smessage %}
          {{ e }}<br>
        {% endfor %}
      </div>
      {% endif %}

      {% set emessage = req.flash('errorMessage') %}
      {% if emessage.length %}
      <div class="alert alert-danger">
        {% for e in emessage %}
        {{ e }}<br>
        {% endfor %}
      </div>
      {% endif %}

      <form action="/admin/notification/slackSetting" method="post" class="form-horizontal" id="slackSettingForm" role="form">
      <fieldset>
        <legend>Slack App Configuration</legend>
        <div class="form-group row">
          <label for="slackClientId" class="offset-1 col-3 col-form-label">Client ID</label>
          <div class="col-7">
            <input id="slackClientId" class="form-control" type="text" name="slackSetting[slack:clientId]" value="{{ slackSetting['slack:clientId'] }}">
          </div>
        </div>

        <div class="form-group row">
          <label for="slackClientSecret" class="offset-1 col-3 col-form-label">Client Secret</label>
          <div class="col-7">
            <input id="slackClientSecret" class="form-control" type="text" name="slackSetting[slack:clientSecret]" value="{{ slackSetting['slack:clientSecret'] }}">
          </div>
        </div>

        <div class="form-group row">
          <div class="offset-4 col-7">
            <button type="submit" class="btn btn-primary">Submit</button>
          </div>
        </div>
      </fieldset>
      <input type="hidden" name="_csrf" value="{{ csrf() }}">
      </form>

      <div class="text-center">
        {% if hasSlackToken %}
        <p>Crowi and Slack is already <strong>connected</strong>.You can re-connect to refresh and overwirte the token with your Slack account.</p>
        <a class="btn btn-secondary" href="{{ slackAuthUrl }}">
          <i class="fab fa-slack"></i> Reconnect to Slack
        </a>
        {% else %}
        <p>Slack clientId and clientSecret is configured. Now, you can connect with Slack.</p>
        <a class="btn btn-primary" href="{{ slackAuthUrl }}">
          <i class="fab fa-slack"></i> Connect to Slack
        </a>
        {% endif %}
      </div>

      {% if hasSlackToken %}
      <hr>

      <h4 class="mt-4">Default Notification Settings for Patterns</h4>

      <div class="row">
        <table class="offset-1 col-10 table table-bordered">
          <thead>
            <th>Pattern</th>
            <th>Channel</th>
            <th>Operation</th>
          </thead>
          <tbody class="admin-notif-list">
            <form id="slackNotificationForm">
            <tr>
              <td>
                <input class="form-control" type="text" name="pathPattern" value="" placeholder="e.g. /projects/xxx/MTG/*">
                <p class="help-block">
                  Path name of wiki. Pattern expression with <code>*</code> can be used.
                </p>
              </td>
              <td>
                <input class="form-control form-inline" type="text" name="channel" value="" placeholder="e.g. project-xxx">
                <p class="help-block">
                  Slack channel name. Without <code>#</code>.
                </p>
              </td>
              <td>
                <input type="hidden" name="_csrf" value="{{ csrf() }}">
                <input type="submit" value="Add" class="btn btn-primary">
              </td>
            </tr>
            </form>

            {% for notif in settings %}
            <tr class="admin-notif-row" data-updatepost-id="{{ notif._id.toString() }}">
              <td>
                {{ notif.pathPattern }}
              </td>
              <td>
                {{ notif.channel }}
              </td>
              <td>
                <form class="admin-remove-updatepost">
                  <input type="hidden" name="id" value="{{ notif._id.toString() }}">
                  <input type="hidden" name="_csrf" value="{{ csrf() }}">
                  <input type="submit" value="Delete" class="btn btn-secondary">
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% endif %}

      <div>
        <h3>How to configure Slack app for Crowi</h3>
        <p>
        Register Crowi as a Slack application, the notification feature for Slack can be enabled.
        </p>
        <h4>1. Register Slack App</h4>
        <p>
        Create App from <a href="https://api.slack.com/applications/new">this link</a>, and fill the form out as below:
        </p>
        <dl>
          <div class="row">
            <dt class="col-4">App Name</dt>
            <dd class="col-8"><code>Crowi</code></dd>
          </div>
          <div class="row">
            <dt class="col-4">Icon</dt>
            <dd class="col-8">
              <p>Upload this image as the icon</p>
              <p>(Free to download and use it) =&gt; <a href="https://github.com/crowi/crowi/tree/master/resource/logo">Crowi Logo</a></p>
            </dd>
          </div>
          <div class="row">
            <dt class="col-4">Short description</dt>
            <dd class="col-8"><code>Crowi's Slack Notification Integration</code></dd>
          </div>
          <div class="row">
            <dt class="col-4">Long description</dt>
            <dd class="col-8"><code>Crowi's Slack Notification Integration</code></dd>
          </div>
          <div class="row"></div>
            <dt class="col-4">Redirect URL</dt>
            <dd class="col-8"><code>{{ baseUrl }}/admin/notification/slackAuth</code></dd>
          </div>
        </dl>
        <p>
        and <strong>Save</strong> it.
        </p>

        <h4>2. Get <code>clientId</code> and <code>clientSecret</code>  in 'Basic Information' tab.</h4>
        <h4>3. After clientId and clientSecret set, click "Connect to Slack" button to start OAuth process.</h4>
        <h4>4. Configure Slack on this notification setting screen</h4>

        <h3>How to enable unfurling links feature</h3>
        <h4>1. Subscribe events from Slack</h4>
        <p>
          Fill the form in <strong>Features > Event Subscriptions</strong> out as below:
        </p>
        <div class="row">
          <dt class="col-4">Request URL</dt>
          <dd class="col-8"><code>{{ appUrl }}/_api/slack/event</code></dd>
          <dt class="col-4">Workspace Events</dt>
          <dd class="col-8"><code>link_shared</code></dd>
          <dt class="col-4">Domains</dt>
          <dd class="col-8">Your crowi domains </dd>
        </div>
      </div>

      <div class="">
        <h3>How to configure Slack app for Crowi</h3>
        <p>
          Register Crowi as a Slack application, the notification feature for Slack can be enabled.
        </p>

        <h4>1. Register Slack App</h4>
        <p>
        Create App from <strong><a href="https://api.slack.com/apps">this link</a></strong>, and fill the form out as below:
        </p>
        <dl class="dl-horizontal">
          <dt>App Name</dt> <dd><code>Crowi</code> </dd>
          <dt>Icon</dt> <dd>Upload this image as the icon (Free to download and use it) =&gt; <a href="https://github.com/crowi/crowi/tree/master/resource/logo">Crowi Logo</a></dd>
          <dt>Redirect URL</dt> <dd><code>{{ baseUrl }}/admin/notification/slackAuth</code> in 'OAuth &amp; Permissions' tab.</dd>
        </dl>

        <h4>2. Get <code>clientId</code> and <code>clientSecret</code> in 'Basic Information' tab.</h4>
        <h4>3. After clientId and clientSecret set, click "Connect to Slack" button to start OAuth process.</h4>
        <h4>4. Configure Slack on this notification setting screen</h4>

        <h3>How to enable unfurling links feature</h3>
        <h4>1. Subscribe events from Slack</h4>
        <p>
          Fill the form in <strong>Features > Event Subscriptions</strong> out as below:
        </p>
        <dl class="dl-horizontal">
          <dt>Request URL</dt> <dd><code>{{ appUrl }}/_api/slack/event</code> </dd>
          <dt>Workspace Events</dt> <dd><code>link_shared</code> </dd>
          <dt>Domains</dt> <dd>Your crowi domains </dd>
        </dl>
      </div>

    </div>
  </div>

</div>
{% endblock content_main %}

{% block content_footer %}
{% endblock content_footer %}



